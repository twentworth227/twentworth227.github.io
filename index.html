<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>liveby</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>
  <script src="https://use.fontawesome.com/ada9a9a588.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet' />
  <link href="stylesheet.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

  <style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

</style>
</head>
<body>

  <div id='map'></div>
  <div class="map-overlay">
    <div class="collapse in" id='features'>
      <h3>Is there something you try to live by every day?</h3>
      <h4>I'm driving across the country asking people this question.<br>
         Click on a point to hear how they respond!</h4>
    </div>
      <button type="button" class="collapse-btn btn btn-dark" data-toggle="collapse" data-target="#features"><i class="far fa-minus-square fa-2x"></i></button>
  </div>

  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoidHdlbnR3b3J0aCIsImEiOiJjank3bmthZXEwMWN5M2hvMmVpZDV4aWhyIn0.aEBI-qd5b-yv7wbstwhLnA';

  var geojson = {
    "type": "FeatureCollection",
    "features": [
      { "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [-73.210398, 44.481452]
      },
      "properties": {
        "unique_id": "1001",
        "title": "Thomas - Burlington, VT",
        "description": "July 15th, 2019",
        "url": "audio_files/upbeat_minor.mp3",
        "img_url": "pictures/first.jpg"
      }
    },
    { "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [-73.1673, 44.0153]
    },
    "properties": {
      "unique_id": "1002",
      "title": "Anderson - Middlebury, VT",
      "description": "July 20th, 2019",
      "url": "audio_files/ner2.mp3",
      "img_url": "pictures/second.jpg"
    }
  },
]
};

function $(x) {return document.getElementById(x);}

var bounds = [
  [-155, 12], // Southwest coordinates
  [-40, 55]  // Northeast coordinates
];


var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/twentworth/cjy7nu17v04vz1cp69y5xka6g',
  center: [-96.5, 39],
  zoom: 4,
  minZoom: 3,
  maxBounds: bounds
});


function play_pause(unique_id) {
  var audio = $(String(unique_id));
  var playicon = $("playstate");
  if (audio.paused) {
    playicon.className = "far fa-pause-circle fa-2x";
    audio.play();
  } else{
    playicon.className = "far fa-play-circle fa-2x";
    audio.pause();
    // audio.currentTime = 0
  }
}

function stop(unique_id) {
  var audio = document.getElementById(String(unique_id));
  var stopicon = $("stopstate");
  var playicon = $("playstate");
  if (audio.playing) {
    playicon.className = "far fa-play-circle fa-2x"
    audio.stop();
    audio.pause();
    audio.currentTime = 0;
  } else{
    playicon.className = "far fa-play-circle fa-2x"
    audio.pause();
    audio.currentTime = 0;
  }
}

function show_image(src, width, height, alt) {
  var img = document.createElement("img");
  img.src = src;
  img.width = 60;
  img.height = 60;
  img.alt = 'could not display image';

  // This next line will just add it to the <body> tag
  document.body.appendChild(img);
}


map.on('load', function() {
  // Add a new source from our GeoJSON data and set the
  // 'cluster' option to true. GL-JS will add the point_count property to your source data.
  map.addSource("points", {
    type: "geojson",
    // Point to GeoJSON data. This example visualizes all M1.0+ earthquakes
    // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
    data: geojson,
    cluster: true,
    clusterMaxZoom: 14, // Max zoom to cluster points on
    clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
  });

  map.addLayer({
    id: "clusters",
    type: "circle",
    source: "points",
    filter: ["has", "point_count"],
    paint: {
      // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
      // with three steps to implement three types of circles:
      //   * Blue, 20px circles when point count is less than 100
      //   * Yellow, 30px circles when point count is between 100 and 750
      //   * Pink, 40px circles when point count is greater than or equal to 750
      // base color: #294151
      "circle-color": [
        "step",
        ["get", "point_count"],
        "#825915",
        100,
        "#825915",
        750,
        "#825915"
      ],
      "circle-radius": [
        "step",
        ["get", "point_count"],
        20,
        100,
        30,
        750,
        40
      ]
    }
  });

  map.addLayer({
    id: "cluster-count",
    type: "symbol",
    source: "points",
    filter: ["has", "point_count"],
    layout: {
      "text-field": "{point_count_abbreviated}",
      "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
      "text-size": 12
    }
  });

  map.addLayer({
    id: "unclustered-point",
    type: "circle",
    source: "points",
    filter: ["!", ["has", "point_count"]],
    paint: {
      "circle-color": "#825915",
      "circle-radius": 6,
      "circle-stroke-width": .5, // .5
      "circle-stroke-color": "#84909a"
    }
  });

  // inspect a cluster on click
  map.on('click', 'clusters', function (e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
    var clusterId = features[0].properties.cluster_id;
    map.getSource('points').getClusterExpansionZoom(clusterId, function (err, zoom) {
      if (err)
      return;

      map.easeTo({
        center: features[0].geometry.coordinates,
        zoom: zoom
      });
    });
  });

  map.on('mouseenter', 'clusters', function () {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('mouseleave', 'clusters', function () {
    map.getCanvas().style.cursor = '';
  });


  map.on('click', 'unclustered-point', function (e) {
    var coordinates = e.features[0].geometry.coordinates.slice();
    var unique_id = e.features[0].properties.unique_id;
    var title = e.features[0].properties.title;
    var description = e.features[0].properties.description;
    var url = e.features[0].properties.url;
    var img_url = e.features[0].properties.img_url;

    // Ensure that if the map is zoomed out such that multiple
    // copies of the feature are visible, the popup appears
    // over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    new mapboxgl.Popup()
    .setLngLat(coordinates)
    .setHTML('<h4>' + title + '</h4><p>' + description + '</p>' +
    '<img src=' + img_url + ' alt="could not display image" style="padding:0px 0px 5px 0px;width:150px;height:150px;">' +
    '<br>' + '<audio id=' + unique_id + ' src=' + url + '></audio>' +
    '<a class="btn btn-light" data-toggle="tooltip" onClick="play_pause(' + unique_id + ')"><i id="playstate" class="far fa-play-circle fa-2x"></i></a>' +
    '<a class="btn btn-light" data-toggle="tooltip" onClick="stop(' + unique_id + ')"><i id="stopstate" class="far fa-stop-circle fa-2x"></i></a>')
    .addTo(map);

    });

  // Change the cursor to a pointer when the mouse is over the places layer.
  map.on('mouseenter', 'unclustered-point', function () {
    map.getCanvas().style.cursor = 'pointer';
  });

  // Change it back to a pointer when it leaves.
  map.on('mouseleave', 'unclustered-point', function () {
    map.getCanvas().style.cursor = '';
  });
});

</script>

</body>
</html>
